name: Deploy ArgoCD

on:
  push:
    tags:
      - '**'

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v2
        - name: Set env
          run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
        - name: checkout argocd repo
          uses: actions/checkout@v2
          with:
            repository: 'weeb-vip/argocd'
            token: ${{ secrets.ACCESS_TOKEN }}
            path: 'argocd'
        - name: deploy to argocd
          env:
            GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
            REPO_NAME: ${{ env.REPO_NAME }}
          # pull argocd repo and push to argocd
          run: |
            find . -type f -name '*.yaml' -print0 | xargs -0 sed -E -i '' 's/(tag:[[:space:]]*).*(# '"$REPO_NAME"')/\1 '"$RELEASE_VERSION"'\2/'
            git add .
            git commit -m "feat: $REPO_NAME $RELEASE_VERSION"
            git push origin main
            
